---
# yamllint disable rule:truthy rule:line-length rule:comments
permissions:
  contents: read

name: Hybrid CI
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 4 * * 1"

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - name: Prepare artifacts directory
        run: mkdir -p "$ARTIFACTS_DIR"
      - uses: prefix-dev/setup-pixi@92815284c57faa15cd896c4d5cfb2d59f32dc43d # v0.8.3
        with:
          cache: true
          locked: true
          environments: automation
      - name: Collect pixi metadata
        run: |
          set +e
          pixi info --json > "$ARTIFACTS_DIR/pixi-info.json" || echo '{"note":"pixi info unavailable"}' > "$ARTIFACTS_DIR/pixi-info.json"
          pixi tree --json > "$ARTIFACTS_DIR/pixi-tree.json" || echo '{"note":"pixi tree unavailable"}' > "$ARTIFACTS_DIR/pixi-tree.json"
          set -e
      - name: Hadolint (Dockerfile)
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: docker/Dockerfile
      # Runs the full Strict Suite
      - name: Run validate (with reports)
        env:
          RUN_SEMGREP: "1"
          PYTEST_ADDOPTS: "--cov-report=xml:${ARTIFACTS_DIR}/coverage.xml --junitxml=${ARTIFACTS_DIR}/tests.xml"
        run: |
          set -o pipefail
          pixi run -e automation validate | tee "$ARTIFACTS_DIR/validate.log"
      - name: Ensure working tree clean (no generated diffs)
        run: git diff --exit-code
      - name: Upload quality artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quality-${{ github.run_id }}
          path: ${{ env.ARTIFACTS_DIR }}/**
          if-no-files-found: warn

  build:
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      ARTIFACTS_DIR: ${{ runner.temp }}/artifacts
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - uses: prefix-dev/setup-pixi@92815284c57faa15cd896c4d5cfb2d59f32dc43d # v0.8.3
        with:
          cache: true
          locked: true
          environments: automation
      - uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1
      - name: Bake plan
        run: |
          mkdir -p "$ARTIFACTS_DIR" build
          docker buildx bake -f docker/docker-bake.hcl --print > "$ARTIFACTS_DIR/bake-plan.json"
      - name: Build devcontainer images (no push)
        id: build
        env:
          REGISTRY: ghcr.io/ray-manaloto/pixi-devcontainer
          CI_SKIP_PUSH: "1"
          SKIP_PUSH: "1"
        run: |
          set -o pipefail
          pixi run -e automation build | tee "$ARTIFACTS_DIR/build.log"
      - name: Summarize OCI artifacts
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          import os

          artifacts = []
          for tar in Path("build").glob("*.tar"):
              stat = tar.stat()
              artifacts.append(
                  {
                      "file": tar.name,
                      "size_bytes": stat.st_size,
                      "modified": stat.st_mtime,
                  },
              )
          out_dir = Path(os.environ["ARTIFACTS_DIR"])
          out_dir.mkdir(parents=True, exist_ok=True)
          (out_dir / "oci-metadata.json").write_text(
              json.dumps({"images": artifacts}, indent=2),
              encoding="utf-8",
          )
          PY
      - name: Upload devcontainer OCI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-build-${{ steps.build.outputs.HASH || github.run_id }}
          path: |
            ${{ env.ARTIFACTS_DIR }}/**
            build/*.tar
          if-no-files-found: error

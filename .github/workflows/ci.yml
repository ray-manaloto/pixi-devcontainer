---
# yamllint disable rule:truthy rule:line-length rule:comments
permissions:
  contents: read

name: Hybrid CI
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 4 * * 1"

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - name: Hadolint (Dockerfile)
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: docker/Dockerfile
      - uses: prefix-dev/setup-pixi@92815284c57faa15cd896c4d5cfb2d59f32dc43d # v0.8.3
        with:
          cache: true
          locked: true
          environments: automation
      # Runs the full Strict Suite
      - run: pixi run -e automation validate
        env:
          RUN_SEMGREP: "1"
      - name: Ensure working tree clean (no generated diffs)
        run: git diff --exit-code

  build:
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - uses: prefix-dev/setup-pixi@92815284c57faa15cd896c4d5cfb2d59f32dc43d # v0.8.3
        with:
          cache: true
          locked: true
          environments: automation
      - uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1
      - name: Build devcontainer images (no push)
        id: build
        env:
          REGISTRY: ghcr.io/ray-manaloto/pixi-devcontainer
          CI_SKIP_PUSH: "1"
          SKIP_PUSH: "1"
        run: pixi run -e automation build
      - name: Upload devcontainer OCI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-oci-${{ steps.build.outputs.HASH || 'unknown' }}
          path: build/*.tar
          if-no-files-found: error

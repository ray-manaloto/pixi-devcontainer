[workspace]
name = "cpp-bleeding-edge"
version = "2026.1.0"
description = "Bleeding edge C++ dev environment (GCC 15.2 / LLVM 21)"
platforms = ["linux-64", "osx-arm64"]
channels = ["conda-forge"]

[system-requirements]
linux = "5.4"
libc = { family = "glibc", version = "2.31" }
macos = "13.0"

[dependencies]
cmake = "*"
ninja = "*"
python = "3.12.*"
sccache = "*"

# --- Feature: Automation (Zero Tolerance Suite) ---
[feature.automation.dependencies]
# Python SDKs
boto3 = "*"
docker-py = "*"
rich = "*"

# Static Analysis & Linters
ruff = "*"
vulture = "*"
deptry = "*"
taplo = "*"
yamllint = "*"
check-jsonschema = "*"
actionlint = "*"
typos = "*"
checkov = "*"
shellcheck = "*"
pytest = "*"
pytest-cov = "*"
pytest-testinfra = "*"
[feature.automation.pypi-dependencies]
ty = "*"
zizmor = "*"
pylint = "*"
pyrefly = "*"
mypy = "*"
uv = "*"

# --- Feature: GCC 15.2 ---
[feature.gcc15.dependencies]
gcc = "*"
gxx = "*"

# --- Feature: LLVM 21 ---
[feature.llvm21.dependencies]
clang = "*"
clangxx = "*"
lld = "*"
lldb = "*"
clang-tools = "*"
llvm-tools = "*"

# --- Feature: Dev Tools ---
[feature.dev.dependencies]
gdb = "*"
starship = "*"
bat = "*"
ripgrep = "*"
direnv = "*"


# --- Environments ---
[environments]
automation = ["automation"]
stable = ["gcc15", "llvm21"]
dev-container = ["gcc15", "llvm21", "dev", "automation"]

[tasks]
lint-ruff-format = "ruff format --check ."
lint-ruff = "ruff check ."
lint-ty = "ty check --python .pixi/envs/automation/bin/python scripts --exclude scripts/tests/test_container.py"
lint-vulture = "vulture scripts docker"
lint-pylint-dup = "pylint --disable=all --enable=duplicate-code scripts"
lint-mypy = "mypy scripts --ignore-missing-imports --implicit-reexport"
lint-semgrep = "sh -c '[ \"${RUN_SEMGREP:-1}\" = \"1\" ] || { echo \"Skipping semgrep (set RUN_SEMGREP=1 to enable)\"; exit 0; }; docker info >/dev/null 2>&1 || { echo \"Skipping semgrep: docker daemon unavailable\"; exit 0; }; docker run --rm -v $(pwd):/src -w /src returntocorp/semgrep:latest semgrep scan --error --config auto --exclude .pixi --exclude .git --exclude build'"
lint-shellcheck = "sh -c 'files=$(git ls-files \"*.sh\"); if [ -z \"$files\" ]; then echo \"No shell scripts; skipping shellcheck\"; else shellcheck $files; fi'"
lint-hadolint = "sh -c 'docker run --rm -i hadolint/hadolint < docker/Dockerfile'"
lint-actionlint = "actionlint"
lint-checkov = "checkov -d docker --quiet --compact"
lint-uv = "uv pip check --project ."
lint-pyrefly = "pyrefly check --ignore-missing-imports=true --python-interpreter-path .pixi/envs/automation/bin/python scripts/*.py scripts/lib/*.py"
lint-taplo = "taplo format --check pixi.toml pyproject.toml"
lint-yamllint = "yamllint .github .devcontainer"
lint-typos = "typos ."
lint-jsonschema = "check-jsonschema --schemafile https://raw.githubusercontent.com/devcontainers/spec/main/schemas/devContainer.schema.json .devcontainer/devcontainer.json"
lint-zizmor = "zizmor .github/workflows"
tests = "pytest --cov=scripts scripts/tests"
ci-store-run = "python -m scripts.gha_monitor --store"
ci-watch = "python -m scripts.gha_monitor --watch"
lint = { cmd = "true", depends-on = [
  "lint-ruff-format",
  "lint-ruff",
  "lint-ty",
  "lint-vulture",
  "lint-pylint-dup",
  "lint-mypy",
  "lint-semgrep",
  "lint-shellcheck",
  "lint-hadolint",
  "lint-actionlint",
  "lint-checkov",
  "lint-uv",
  "lint-pyrefly",
  "lint-taplo",
  "lint-yamllint",
  "lint-typos",
  "lint-jsonschema",
  "lint-zizmor",
] }
validate = { cmd = "true", depends-on = [
  "git-clean",
  "lint",
  "tests",
], description = "Run all linters, static analyzers, and tests" }
prepush = { cmd = "true", depends-on = [
  "validate",
  "docker-bake-print",
  "docs-validation-matrix",
], description = "Full local gate before push: lint/tests + docker bake --print" }
build = { cmd = "python -m scripts.build", env = { PYTHONUNBUFFERED = "1" } }
setup-dev = { cmd = "python -m scripts.setup_dev", env = { PYTHONUNBUFFERED = "1" } }
init-container = "python -m scripts.lib.container_init"
git-clean = { cmd = "python -c 'import subprocess, sys; out = subprocess.check_output([\"git\",\"status\",\"--porcelain\"], text=True);\nif out.strip():\n    sys.stderr.write(\"Working tree is dirty. Commit or stash changes before pushing.\\n\" + out)\n    sys.exit(1)\nprint(\"Git working tree clean\")'" }
docker-bake-print = "docker buildx bake -f docker/docker-bake.hcl --print"
docs-validation-matrix = "python -m scripts.generate_validation_matrix"
renovate-dispatch = { cmd = "gh workflow run renovate.yml", depends-on = [
  "prepush",
], description = "Run full local gate then trigger Renovate workflow_dispatch" }
renovate-status = { cmd = "python - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\n    \"gh\",\n    \"run\",\n    \"list\",\n    \"--workflow\",\n    \"renovate.yml\",\n    \"--limit\",\n    \"5\",\n    \"--json\",\n    \"databaseId,headSha,status,conclusion,createdAt,displayTitle\",\n], text=True)\nfor row in json.loads(raw):\n    print(\n        f\"{row['databaseId']}\\t{row['status']}\\t{row.get('conclusion','')}\\t{row['createdAt']}\\t{row['headSha']}\\t{row['displayTitle']}\"\n    )\nPY", description = "Show last 5 Renovate workflow runs (id, status, conclusion, time, SHA, title)" }
validate-renovate = { cmd = "true", depends-on = [
  "lint-actionlint",
  "lint-yamllint",
], description = "Renovate workflow gate: actionlint + yamllint only" }
devcontainer-ports = { cmd = "python -m scripts.devcontainer_ports", description = "List devcontainer permutations and suggested SSH ports" }
